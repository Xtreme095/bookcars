# Phase 1.4: Supplier Self-Registration Portal

**Status:** üî¥ Not Started
**Priority:** P1 - HIGH
**Duration:** 2 weeks
**Started:** Not started
**Completed:** Not completed
**Dependencies:** Commission Management System (1.1)

---

## üìã OVERVIEW

The Supplier Self-Registration Portal enables car rental suppliers to apply to join the platform without manual intervention. This scalable system includes document verification, OIB validation, and an admin approval workflow.

---

## üéØ OBJECTIVES

1. Public-facing "Become a Partner" landing page
2. Multi-step registration wizard
3. Document upload and verification
4. Croatian OIB validation
5. Admin approval workflow
6. Automated account creation
7. Email notifications throughout process
8. Tiered pricing presentation

---

## üìä DATABASE CHANGES

### Update User Model

**File:** `backend/src/models/User.ts`

**Add registration/verification fields:**

```typescript
{
  // Registration & verification
  registrationStatus: 'pending' | 'documents_submitted' | 'under_review' | 'approved' | 'rejected'
  rejectionReason: string
  verificationDocuments: [{
    type: 'id_card' | 'drivers_license' | 'company_registration' | 'tax_certificate' | 'bank_statement'
    file: string
    uploadedAt: Date
    verified: boolean
  }]

  // Onboarding progress
  onboardingStep: number // 1-6
  onboardingCompleted: boolean

  // Approval tracking
  reviewedBy: ObjectId // Admin who reviewed
  reviewedAt: Date
  approvedAt: Date
}
```

---

### New Model: SupplierApplication

**File:** `backend/src/models/SupplierApplication.ts`

```typescript
{
  _id: ObjectId

  // Basic info
  email: string
  fullName: string
  phone: string

  // Company details
  companyName: string
  oib: string // Croatian tax ID (11 digits)
  companyAddress: string
  companyCity: string
  companyZip: string
  companyPhone: string
  websiteUrl: string

  // Fleet info
  numberOfVehicles: number
  vehicleTypes: [string]
  operatingCities: [string]

  // Banking
  bankAccountHolder: string
  iban: string // Croatian IBAN: HR + 19 digits
  swiftBic: string
  bankName: string

  // Documents
  documents: [{
    type: string
    file: string
    uploadedAt: Date
  }]

  // Application status
  status: 'draft' | 'submitted' | 'under_review' | 'approved' | 'rejected'
  submittedAt: Date
  reviewedBy: ObjectId
  reviewedAt: Date
  reviewNotes: string
  rejectionReason: string

  // Converted to User
  userId: ObjectId

  createdAt: Date
  updatedAt: Date
}
```

**Indexes:**
- `{ email: 1 }` - unique
- `{ oib: 1 }` - unique
- `{ status: 1, submittedAt: -1 }`

---

## üîå API ENDPOINTS

### Start Application

**POST** `/api/supplier-registration/start`

**Request:**
```json
{
  "email": "supplier@example.com",
  "fullName": "Marko Horvat",
  "phone": "+385 98 123 4567",
  "password": "SecurePass123"
}
```

**Response:**
```json
{
  "applicationId": "...",
  "token": "..."
}
```

---

### Complete Application

**PUT** `/api/supplier-registration/:applicationId`

**Request:**
```json
{
  "companyDetails": {
    "companyName": "Horvat Rent-a-Car",
    "oib": "12345678901",
    "address": "Ilica 123",
    "city": "Zagreb",
    "zip": "10000"
  },
  "fleetInfo": {
    "numberOfVehicles": "6-10",
    "vehicleTypes": ["Mali automobili", "SUV"],
    "operatingCities": ["Zagreb", "Split"]
  },
  "bankDetails": {
    "accountHolder": "Marko Horvat",
    "iban": "HR1234567890123456789",
    "swiftBic": "ZABAHR2X",
    "bankName": "Zagrebaƒçka banka"
  }
}
```

---

### Upload Documents

**POST** `/api/supplier-registration/:applicationId/documents`

**FormData:**
- `type`: Document type
- `file`: File upload

---

### Submit Application

**POST** `/api/supplier-registration/:applicationId/submit`

Submits application for admin review.

---

### Get Pending Applications (Admin)

**GET** `/api/admin/supplier-applications`

**Query:**
- `status` - Filter by status
- `page` - Page number
- `limit` - Items per page

---

### Review Application (Admin)

**POST** `/api/admin/supplier-applications/:id/review`

**Request:**
```json
{
  "action": "approve" | "reject",
  "notes": "Application approved. Welcome!",
  "commissionRate": 12,
  "tier": "silver"
}
```

---

## üíª FRONTEND PAGES

### Public: Become a Supplier Landing

**File:** `frontend/src/pages/BecomeSupplier.tsx`

**Sections:**
1. **Hero Section**
   - "Postanite partner BookCars platforme"
   - CTA: "Zapoƒçni registraciju"

2. **Benefits**
   - More bookings
   - Digital platform
   - Real-time analytics
   - Automatic payments

3. **How It Works**
   - Step 1: Register
   - Step 2: Upload documents
   - Step 3: Add vehicles
   - Step 4: Receive bookings

4. **Pricing Tiers**
   - **Basic:** 0‚Ç¨/month, 15% commission
   - **Silver:** 500‚Ç¨/month, 12% commission (POPULAR)
   - **Gold:** 1000‚Ç¨/month, 10% commission

5. **FAQ**

---

### Registration Wizard

**File:** `frontend/src/pages/SupplierRegistration.tsx`

**6-Step Process:**

#### Step 1: Basic Info
- Email (with validation)
- Full name
- Phone
- Password

#### Step 2: Company Details
- Company name
- OIB (with validation)
- Address
- City
- Postal code
- Website (optional)

#### Step 3: Fleet Info
- Number of vehicles (dropdown)
- Vehicle types (multi-select)
- Operating cities (multi-select)

#### Step 4: Bank Details
- Account holder
- IBAN (with validation)
- SWIFT/BIC
- Bank name

#### Step 5: Documents
- ID card / Passport
- Company registration certificate
- OIB certificate
- Bank statement

#### Step 6: Review & Submit
- Summary of all info
- Terms & conditions checkbox
- Submit button

---

### Admin: Application Review

**File:** `admin/src/pages/SupplierApplications.tsx`

**Features:**
- Applications list with filters
- Status badges
- Quick view modal
- Document viewer
- Approve/Reject buttons
- Commission rate setup
- Email notification preview

---

## üìß EMAIL TEMPLATES

### Application Received

**Subject:** Va≈°a prijava je primljena - BookCars

```
Po≈°tovani/a {fullName},

Hvala ≈°to ste aplicirali da postanete partner BookCars platforme.

Va≈°a prijava je primljena i trenutno je u postupku provjere.
Na≈° tim ƒáe pregledati va≈°u prijavu u roku od 2-3 radna dana.

Pratite status prijave na: {statusLink}

S po≈°tovanjem,
BookCars tim
```

---

### Application Approved

**Subject:** ƒåestitamo! Va≈°a prijava je odobrena - BookCars

```
Po≈°tovani/a {fullName},

Odobrili smo va≈°u prijavu! üéâ

Va≈° raƒçun je kreiran i mo≈æete zapoƒçeti s dodavanjem vozila.

Va≈°i pristupni podaci:
Email: {email}
Dashboard: {dashboardLink}

Sljedeƒái koraci:
1. Prijavite se na dashboard
2. Dovr≈°ite postavljanje profila
3. Dodajte svoja vozila
4. Postavite cijene
5. Aktivirajte oglase

Va≈°a stopa provizije: {commissionRate}%
Tier: {tier}

Dobrodo≈°li u BookCars obitelj!

S po≈°tovanjem,
BookCars tim
```

---

### Application Rejected

**Subject:** Obavijest o va≈°oj prijavi - BookCars

```
Po≈°tovani/a {fullName},

Na≈æalost, trenutno ne mo≈æemo odobriti va≈°u prijavu.

Razlog: {rejectionReason}

Mo≈æete aplicirati ponovno nakon ≈°to rije≈°ite navedene probleme.

Za dodatna pitanja, kontaktirajte nas na: support@bookcars.hr

S po≈°tovanjem,
BookCars tim
```

---

## ‚úÖ OIB VALIDATION

**File:** `backend/src/utils/validators.ts`

Croatian OIB (tax ID) validation using ISO 7064, MOD 11-10:

```typescript
export function validateOIB(oib: string): boolean {
  // OIB must be exactly 11 digits
  if (!/^\d{11}$/.test(oib)) return false

  // ISO 7064, MOD 11-10 algorithm
  let product = 10
  for (let i = 0; i < 10; i++) {
    let sum = (parseInt(oib[i]) + product) % 10
    if (sum === 0) sum = 10
    product = (sum * 2) % 11
  }

  const checksum = (11 - product) % 10
  return checksum === parseInt(oib[10])
}
```

**Example Valid OIBs:**
- 12345678903
- 98765432108

---

## üìù IMPLEMENTATION CHECKLIST

### Week 1: Backend & Database
- [ ] Create SupplierApplication model
- [ ] Update User model with registration fields
- [ ] Create supplier registration controller
- [ ] Implement registration API endpoints
- [ ] Add OIB validation utility
- [ ] Add IBAN validation utility
- [ ] Create document upload handler
- [ ] Add email notification service
- [ ] Write unit tests

### Week 2: Frontend & Admin
- [ ] Create "Become a Supplier" landing page
- [ ] Build 6-step registration wizard
- [ ] Add form validation (OIB, IBAN)
- [ ] Implement document upload component
- [ ] Create admin application review page
- [ ] Build review modal with tabs
- [ ] Implement approve/reject workflow
- [ ] Add email preview feature
- [ ] Test complete flow end-to-end

---

## üìä SUCCESS METRICS

- ‚úÖ Suppliers can complete registration in < 10 minutes
- ‚úÖ OIB validation prevents invalid applications
- ‚úÖ Admin can review application in < 5 minutes
- ‚úÖ Automated emails sent correctly
- ‚úÖ Account creation works seamlessly
- ‚úÖ Documents uploaded and stored securely

---

## üö® CRITICAL NOTES

1. **OIB Validation:** Must be accurate. Invalid OIBs cannot be registered.

2. **IBAN Validation:** Croatian IBANs start with "HR" + 19 digits.

3. **Document Storage:** Store in secure CDN location, not public.

4. **GDPR Compliance:** Handle personal data according to regulations.

5. **Email Delivery:** Use reliable SMTP service for notifications.

---

## üìö FILES TO CREATE/MODIFY

### New Files
- `backend/src/models/SupplierApplication.ts`
- `backend/src/controllers/supplierRegistrationController.ts`
- `backend/src/routes/supplierRegistrationRoutes.ts`
- `backend/src/config/supplierRegistrationRoutes.config.ts`
- `backend/src/utils/validators.ts`
- `frontend/src/pages/BecomeSupplier.tsx`
- `frontend/src/pages/SupplierRegistration.tsx`
- `admin/src/pages/SupplierApplications.tsx`
- `frontend/src/assets/css/become-supplier.css`
- `frontend/src/assets/css/supplier-registration.css`
- `admin/src/assets/css/supplier-applications.css`

### Modified Files
- `backend/src/models/User.ts`
- `backend/src/app.ts`
- `frontend/src/App.tsx`
- `admin/src/App.tsx`

---

## üîÑ STATUS LOG

| Date | Status | Notes |
|------|--------|-------|
| 2024-12-24 | Not Started | Documentation created |
