# Phase 1.1: Commission Management System

**Status:** üî¥ Not Started
**Priority:** P0 - CRITICAL
**Duration:** 2-3 weeks
**Started:** Not started
**Completed:** Not completed

---

## üìã OVERVIEW

The Commission Management System is the core monetization infrastructure for the BookCars platform. It tracks all financial transactions between suppliers, customers, and the platform, calculates commissions, manages payouts, and generates invoices for Croatian tax compliance.

---

## üéØ OBJECTIVES

1. **Automatic commission calculation** on every booking
2. **Supplier revenue tracking** in real-time
3. **Admin payout management** with full audit trail
4. **Croatian tax compliance** (PDV/VAT 25%)
5. **Invoice generation** for all transactions
6. **Tiered commission rates** to incentivize volume

---

## üìä DATABASE CHANGES

### New Model: CommissionTransaction

**File:** `backend/src/models/CommissionTransaction.ts`

```typescript
{
  _id: ObjectId
  booking: ObjectId // Reference to Booking
  supplier: ObjectId // Reference to User (supplier)

  // Financial breakdown
  totalBookingAmount: number // Total paid by customer
  supplierEarnings: number // Amount supplier receives
  platformCommission: number // Your commission
  commissionType: 'flat' | 'percentage'
  commissionValue: number // Actual percentage or flat amount
  paymentGatewayFee: number // Stripe/PayPal fees
  netRevenue: number // Your profit after gateway fees

  // Tax (Croatian PDV - VAT)
  pdvRate: number // 25% (Croatia VAT rate)
  pdvAmount: number // VAT amount on commission

  // Payout tracking
  payoutStatus: 'pending' | 'processing' | 'paid' | 'failed'
  payoutDate: Date
  payoutMethod: 'bank_transfer' | 'hold' | 'manual'
  payoutReference: string // Bank transaction reference

  // Documentation
  invoice: string // Path to generated invoice PDF
  invoiceNumber: string // Sequential invoice number

  createdAt: Date
  updatedAt: Date
}
```

**Indexes:**
- `{ booking: 1 }` - unique
- `{ supplier: 1, payoutStatus: 1 }`
- `{ createdAt: -1 }`
- `{ payoutDate: 1 }`

---

### Update User Model

**File:** `backend/src/models/User.ts`

**Add fields for suppliers:**

```typescript
{
  // Commission settings
  commissionType: 'flat' | 'percentage' // Default: 'percentage'
  commissionPercentage: number // Default: 15 (15%)
  commissionFlat: number // Flat fee in EUR

  // Payout settings
  bankAccountHolder: string
  bankName: string
  iban: string // Croatian IBAN: HR + 19 digits
  swiftBic: string

  // Tiering (based on monthly bookings)
  tier: 'basic' | 'silver' | 'gold' // Default: 'basic'
  tierCommissionRate: number // Override commission based on tier

  // Financial tracking
  totalRevenue: number // Lifetime revenue
  currentMonthBookings: number // Reset monthly
  lastPayoutDate: Date
  pendingPayout: number // Amount pending payout

  // Croatian business info
  companyName: string
  oib: string // Croatian Tax ID (OIB - 11 digits)
  companyAddress: string
  companyCity: string
  companyZip: string

  // Verification
  businessVerified: boolean
  verificationDocuments: [string] // Paths to uploaded docs
}
```

---

## üîå API ENDPOINTS

### Commission Calculation

**POST** `/api/calculate-commission`

Calculate commission for a booking.

**Request:**
```json
{
  "supplierId": "string",
  "bookingAmount": 450.00
}
```

**Response:**
```json
{
  "supplierEarnings": 382.50,
  "platformCommission": 67.50,
  "commissionType": "percentage",
  "commissionRate": 15,
  "breakdown": {
    "baseAmount": 300.00,
    "insuranceFees": 100.00,
    "extrasFees": 50.00,
    "commission": 67.50,
    "pdv": 16.88
  }
}
```

---

### Get Commission Transactions

**GET** `/api/commission-transactions`

Get list of commission transactions with filters.

**Query Parameters:**
- `supplierId` (optional) - Filter by supplier
- `status` (optional) - Filter by payout status
- `dateFrom` (optional) - Start date
- `dateTo` (optional) - End date
- `page` (required) - Page number
- `limit` (required) - Items per page

**Response:**
```json
{
  "transactions": [
    {
      "_id": "...",
      "booking": {...},
      "supplier": {...},
      "totalBookingAmount": 450.00,
      "supplierEarnings": 382.50,
      "platformCommission": 67.50,
      "payoutStatus": "pending",
      "createdAt": "2024-12-24T10:00:00Z"
    }
  ],
  "totalRecords": 156,
  "page": 1
}
```

---

### Process Payout

**POST** `/api/process-payout`

Process payout to supplier (Admin only).

**Request:**
```json
{
  "supplierId": "string",
  "amount": 2500.00,
  "transactionIds": ["id1", "id2", "id3"],
  "payoutMethod": "bank_transfer",
  "payoutReference": "BANK-REF-123456"
}
```

**Response:**
```json
{
  "success": true,
  "payoutId": "...",
  "amount": 2500.00,
  "transactionsUpdated": 12
}
```

---

### Get Supplier Revenue Stats

**GET** `/api/supplier-revenue/:supplierId`

Get revenue statistics for a supplier.

**Response:**
```json
{
  "totalRevenue": 45000.00,
  "pendingPayout": 2500.00,
  "lastPayout": "2024-12-01T00:00:00Z",
  "currentMonthEarnings": 3800.00,
  "currentMonthBookings": 15,
  "commissionRate": 12,
  "tier": "silver",
  "revenueChart": [
    { "month": "2024-01", "revenue": 3200.00 },
    { "month": "2024-02", "revenue": 4100.00 }
  ]
}
```

---

### Update Supplier Commission Rate

**PUT** `/api/admin/supplier-commission/:supplierId`

Admin updates supplier commission settings.

**Request:**
```json
{
  "commissionType": "percentage",
  "commissionValue": 12,
  "tier": "silver"
}
```

---

## üíª FRONTEND/ADMIN UI

### Admin Pages

#### 1. Commission Management Dashboard

**File:** `admin/src/pages/CommissionManagement.tsx`

**Features:**
- Overview cards (Total Revenue, Pending Payouts, This Month)
- Commission transactions table
- Filters: Supplier, Date range, Status
- Export to CSV/PDF
- Process payout button
- Revenue chart

#### 2. Supplier Revenue Page

**File:** `admin/src/pages/SupplierRevenue.tsx`

**Features:**
- Current balance display
- Earnings history table
- Commission rate display
- Payout history
- Bank account details
- Export earnings statement

---

### Admin Components

#### Commission Calculator

**File:** `admin/src/components/CommissionCalculator.tsx`

Real-time commission calculation widget showing:
- Booking amount input
- Commission rate display
- Platform fee breakdown
- Supplier earnings
- PDV calculation

---

## üìù IMPLEMENTATION CHECKLIST

### Week 1: Backend

- [ ] Create `CommissionTransaction` model
- [ ] Update `User` model with commission fields
- [ ] Create `commissionController.ts`
- [ ] Implement commission calculation utilities
- [ ] Create commission API routes
- [ ] Update booking creation to generate commission transactions
- [ ] Add invoice generation service (PDF)
- [ ] Write unit tests for commission calculations

### Week 2: Admin UI

- [ ] Create Commission Management page
- [ ] Create Supplier Revenue page
- [ ] Create CommissionCalculator component
- [ ] Add commission settings to supplier edit page
- [ ] Create payout processing interface
- [ ] Add financial reporting dashboard
- [ ] Implement CSV/PDF export

### Week 3: Testing & Refinement

- [ ] Integration tests for payment ‚Üí commission flow
- [ ] Test tier-based commission changes
- [ ] Test payout processing
- [ ] Generate and review sample invoices
- [ ] Load testing for commission calculations
- [ ] Admin UI polish and UX improvements

---

## üß™ TESTING REQUIREMENTS

### Unit Tests
- Commission calculation accuracy
- PDV/VAT calculation
- Tier-based rate changes
- Payment gateway fee calculation

### Integration Tests
- Booking creation ‚Üí Commission transaction
- Multiple bookings ‚Üí Payout batch
- Commission rate changes ‚Üí Historical data
- Failed payment ‚Üí No commission

### E2E Tests
- Complete booking ‚Üí Commission created
- Admin processes payout ‚Üí Transactions updated
- Supplier views revenue ‚Üí Accurate data

---

## üìä SUCCESS METRICS

- ‚úÖ Commission calculated correctly on 100% of bookings
- ‚úÖ Suppliers can view earnings in real-time
- ‚úÖ Admin can process payouts in < 2 minutes
- ‚úÖ Automatic invoice generation works
- ‚úÖ No discrepancies in financial reports
- ‚úÖ System handles 1000+ transactions without performance issues

---

## üö® CRITICAL NOTES

1. **Data Integrity:** Commission calculations must be 100% accurate. Any errors directly impact revenue.

2. **Croatian Tax Compliance:** All invoices must include:
   - OIB (tax ID)
   - PDV (VAT) amount clearly stated
   - Sequential invoice numbers
   - Company registration details

3. **Security:** Payout processing is admin-only. Implement strong authorization checks.

4. **Audit Trail:** Every commission change must be logged for accounting.

5. **Currency:** All amounts in EUR (Croatia uses Euro).

---

## üìö FILES TO CREATE/MODIFY

### New Files
- `backend/src/models/CommissionTransaction.ts`
- `backend/src/controllers/commissionController.ts`
- `backend/src/routes/commissionRoutes.ts`
- `backend/src/config/commissionRoutes.config.ts`
- `backend/src/utils/commissionHelper.ts`
- `backend/src/utils/invoiceGenerator.ts`
- `admin/src/pages/CommissionManagement.tsx`
- `admin/src/pages/SupplierRevenue.tsx`
- `admin/src/components/CommissionCalculator.tsx`
- `admin/src/services/CommissionService.ts`
- `admin/src/assets/css/commission-management.css`
- `admin/src/assets/css/supplier-revenue.css`

### Modified Files
- `backend/src/models/User.ts`
- `backend/src/controllers/bookingController.ts`
- `backend/src/app.ts` (add commission routes)
- `admin/src/App.tsx` (add new routes)
- `admin/src/components/Header.tsx` (add menu items)

---

## üîÑ STATUS LOG

| Date | Status | Notes |
|------|--------|-------|
| 2024-12-24 | Not Started | Documentation created |

---

**Next:** Once implementation begins, update this document with progress and any deviations from the plan.
